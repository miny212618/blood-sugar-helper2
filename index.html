
<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>血糖助手紀錄版</title>
<link href="favicon.ico" rel="icon" type="image/x-icon"/>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #eaffea; }
    input, button { margin: 5px 0; padding: 5px; width: 100%; max-width: 300px; }
    .section { margin-bottom: 30px; }
    .record-box { background: #eef; padding: 10px; margin-top: 10px; white-space: pre-wrap; }
    .record-entry { margin-bottom: 10px; }
    .record-buttons { margin-top: 5px; }
  </style>
<link href="manifest.json" rel="manifest"/></head>
<body>
<h2 style="text-align: center;">血糖助手</h2>
<div class="section">
  餐前血糖（mg/dL）<br/>
<input id="preMealBloodSugar" oninput="autoCalculate()" type="number"/><br/>

  目標血糖（mg/dL）<br/>
<input id="targetBloodSugar" oninput="autoCalculate()" type="number" value="100"/><br/>


  早餐 CI 值：<br/>
<input id="breakfastCI" type="number" value="8"/><br/>

  午餐 CI 值：<br/>
<input id="lunchCI" type="number" value="10"/><br/>

  晚餐 CI 值：<br/>
<input id="dinnerCI" type="number" value="10"/><br/>

  選擇餐別：<input id="meal"/><br/>
<select id="mealType" onchange="updateCIFromMeal()">
<option value="breakfast">早餐</option>
<option value="lunch">午餐</option>
<option value="dinner">晚餐</option>
</select><br/>

  
  血糖修正因子（每 1U 可降幾 mg/dL）<br/>
<input id="correctionFactor" oninput="autoCalculate()" type="number" value="100"/><br/>

  碳水化合物（g）<br/>
<input id="carbs" oninput="autoCalculate()" type="number"/><br/>

  碳水比（CI 值）<br/><br/>
<input id="carbRatio" oninput="autoCalculate()" type="number"/><br/>

  實際打的胰島素劑量<br/>
<input id="actualInsulin" oninput="autoCalculate()" type="number"/><br/>

  備註（吃什麼）<br/>
<input id="note" type="text"/><br/>
<button onclick="saveRecord()">儲存資料</button><br/><br/>
<div id="suggestedInsulin" style="font-weight:bold; color:green;"></div>
<div id="predictedBloodSugar" style="font-weight:bold; color:green;"></div>
</div>
<h3>今日紀錄</h3>
<div class="record-box" id="records"></div>
<button onclick="copyRecords()">複製今日紀錄</button>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const mealSelect = document.querySelector('select[name="meal"]');
    const ciInput = document.querySelector('input[name="ci"]');

    function getSuggestedCI(meal) {
        const day = new Date().getDay(); // 0=日, 1=一, 2=二 ...
        if (day === 2 && meal === "breakfast") return 8;
        if (day === 2 && meal === "lunch") return 10;
        if (day === 2 && meal === "dinner") return 10;
        if (day === 1 && meal === "breakfast") return 9;
        return "";
    }

    function updateCI() {
        if (!mealSelect || !ciInput) return;
        const selectedMeal = mealSelect.value;
        const ciValue = getSuggestedCI(selectedMeal);
        if (ciValue !== "") {
            ciInput.value = ciValue;
        }
    }

    mealSelect?.addEventListener("change", updateCI);
    updateCI(); // 頁面載入時自動執行
});

// 修正函式：選擇餐別自動更新碳水比（CI 值）
function updateCIFromMeal() {
    const mealType = document.getElementById("mealType").value;
    let ciValue = "";
    if (mealType === "breakfast") {
        ciValue = document.getElementById("breakfastCI").value;
    } else if (mealType === "lunch") {
        ciValue = document.getElementById("lunchCI").value;
    } else if (mealType === "dinner") {
        ciValue = document.getElementById("dinnerCI").value;
    }
    document.getElementById("carbRatio").value = ciValue;
    autoCalculate();
}

// 自動計算預估血糖與建議胰島素劑量
function autoCalculate() {
    const preMeal = parseFloat(document.getElementById("preMealBloodSugar").value);
    const target = parseFloat(document.getElementById("targetBloodSugar").value);
    const correction = parseFloat(document.getElementById("correctionFactor").value);
    const carbs = parseFloat(document.getElementById("carbs").value);
    const ci = parseFloat(document.getElementById("carbRatio").value);

    let insulinDose = "";
    let predictedBS = "";

    if (!isNaN(preMeal) && !isNaN(target) && !isNaN(correction) && !isNaN(carbs) && !isNaN(ci)) {
        insulinDose = ((preMeal - target) / correction) + (carbs / ci);
        insulinDose = insulinDose.toFixed(2);
        predictedBS = preMeal - ((parseFloat(document.getElementById("actualInsulin").value) || 0) * correction);
        predictedBS = predictedBS.toFixed(2);
    }

    document.getElementById("suggestedInsulin").innerText = insulinDose ? "建議劑量：" + insulinDose + " U" : "";
    document.getElementById("predictedBloodSugar").innerText = predictedBS ? "預估血糖：<input id="bloodSugar"/>" + predictedBS + " mg/dL" : "";
}

// 修正函式：選擇餐別自動更新碳水比（CI 值）
function updateCIFromMeal() {
    const mealType = document.getElementById("mealType").value;
    let ciValue = "";
    if (mealType === "breakfast") {
        ciValue = document.getElementById("breakfastCI").value;
    } else if (mealType === "lunch") {
        ciValue = document.getElementById("lunchCI").value;
    } else if (mealType === "dinner") {
        ciValue = document.getElementById("dinnerCI").value;
    }
    document.getElementById("carbRatio").value = ciValue;
    autoCalculate();
}

// 修正計算公式：反推預估血糖
function autoCalculate() {
    const preMeal = parseFloat(document.getElementById("preMealBloodSugar").value);
    const target = parseFloat(document.getElementById("targetBloodSugar").value);
    const correction = parseFloat(document.getElementById("correctionFactor").value);
    const carbs = parseFloat(document.getElementById("carbs").value);
    const ci = parseFloat(document.getElementById("carbRatio").value);
    const actualInsulin = parseFloat(document.getElementById("actualInsulin").value);

    let insulinDose = "";
    let predictedBS = "";

    if (!isNaN(preMeal) && !isNaN(target) && !isNaN(correction) && !isNaN(carbs) && !isNaN(ci)) {
        insulinDose = ((preMeal - target) / correction) + (carbs / ci);
        insulinDose = insulinDose.toFixed(2);
    }

    if (!isNaN(preMeal) && !isNaN(actualInsulin) && !isNaN(correction) && !isNaN(carbs) && !isNaN(ci)) {
        predictedBS = preMeal - ((actualInsulin - (carbs / ci)) * correction);
        predictedBS = predictedBS.toFixed(2);
    }

    document.getElementById("suggestedInsulin").innerText = insulinDose ? "建議劑量：" + insulinDose + " U" : "";
    document.getElementById("predictedBloodSugar").innerText = predictedBS ? "預估血糖：" + predictedBS + " mg/dL" : "";
}

// 加入儲存函式
function saveRecord() {
    const date = new Date().toLocaleDateString();
    const mealType = document.getElementById("mealType").value;
    const preMeal = document.getElementById("preMealBloodSugar").value;
    const carbs = document.getElementById("carbs").value;
    const insulin = document.getElementById("actualInsulin").value;
    const note = document.getElementById("note").value;

    const existing = JSON.parse(localStorage.getItem("records") || "{}");
    if (!existing[date]) existing[date] = {};
    existing[date][mealType] = { preMeal, carbs, insulin, note };

    localStorage.setItem("records", JSON.stringify(existing));
    loadRecords();
}

function loadRecords() {
    const date = new Date().toLocaleDateString();
    const data = JSON.parse(localStorage.getItem("records") || "{}");
    const today = data[date] || {};
    const area = document.getElementById("records");
    area.innerText = "";

    ["breakfast", "lunch", "dinner"].forEach(meal => {
        if (today[meal]) {
            area.innerText += meal + "：血糖 " + today[meal].preMeal + "，碳水 " + today[meal].carbs + "g，胰島素 " + today[meal].insulin + "U，備註：" + today[meal].note + "\n";
        }
    });
}

function copyRecords() {
    const text = document.getElementById("records").innerText;
    navigator.clipboard.writeText(text).then(() => alert("已複製"));
}

window.onload = loadRecords;
</script>

<script>
    function editRecord(index) {
        const records = JSON.parse(localStorage.getItem('records') || '[]');
        const record = records[index];
        document.getElementById('date').value = record.date;
        document.getElementById('meal').value = record.meal;
        document.getElementById('bloodSugar').value = record.bloodSugar;
        document.getElementById('carbs').value = record.carbs;
        document.getElementById('insulin').value = record.insulin;
        document.getElementById('note').value = record.note;
        localStorage.setItem('editIndex', index);
    }

    function deleteRecord(index) {
        let records = JSON.parse(localStorage.getItem('records') || '[]');
        records.splice(index, 1);
        localStorage.setItem('records', JSON.stringify(records));
        displayRecords();
    }

    function displayRecords() {
        const records = JSON.parse(localStorage.getItem('records') || '[]');
        const display = document.getElementById('recordDisplay');
        display.innerHTML = '';
        records.forEach((record, index) => {
            const div = document.createElement('div');
            div.className = 'record-box';
            div.innerHTML = `
                <strong>${record.date} ${record.meal}</strong><br/>
                血糖: ${record.bloodSugar}、碳水: ${record.carbs}、胰島素: ${record.insulin}<br/>
                備註: ${record.note}<br/>
                <button onclick="editRecord(${index})">修改</button>
                <button onclick="deleteRecord(${index})">刪除</button>
            `;
            display.appendChild(div);
        });
    }

    function saveRecord() {
        const records = JSON.parse(localStorage.getItem('records') || '[]');
        const newRecord = {
            date: document.getElementById('date').value,
            meal: document.getElementById('meal').value,
            bloodSugar: document.getElementById('bloodSugar').value,
            carbs: document.getElementById('carbs').value,
            insulin: document.getElementById('insulin').value,
            note: document.getElementById('note').value
        };
        const editIndex = localStorage.getItem('editIndex');
        if (editIndex !== null) {
            records[parseInt(editIndex)] = newRecord;
            localStorage.removeItem('editIndex');
        } else {
            records.push(newRecord);
        }
        localStorage.setItem('records', JSON.stringify(records));
        displayRecords();
    }

    window.onload = displayRecords;
</script>

</body>
</html>
