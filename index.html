
<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>è¡€ç³–åŠ©æ‰‹ç´€éŒ„ç‰ˆ</title>
<link href="favicon.ico" rel="icon" type="image/x-icon"/>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #eaffea; }
    input, button { margin: 5px 0; padding: 5px; width: 100%; max-width: 300px; }
    .section { margin-bottom: 30px; }
    .record-box { background: #eef; padding: 10px; margin-top: 10px; white-space: pre-wrap; }
    .record-entry { margin-bottom: 10px; }
    .record-buttons { margin-top: 5px; }
  </style>
<link href="manifest.json" rel="manifest"/></head>
<body>
<h2 style="text-align: center;">è¡€ç³–åŠ©æ‰‹</h2>
<div class="section">
  é¤å‰è¡€ç³–ï¼ˆmg/dLï¼‰<br/>
<input id="preMealBloodSugar" oninput="autoCalculate()" type="number"/><br/>

  ç›®æ¨™è¡€ç³–ï¼ˆmg/dLï¼‰<br/>
<input id="targetBloodSugar" oninput="autoCalculate()" type="number" value="100"/><br/>

  è¡€ç³–ä¿®æ­£å› å­ï¼ˆæ¯ 1U å¯é™å¹¾ mg/dLï¼‰<br/>
<input id="correctionFactor" oninput="autoCalculate()" type="number" value="100"/><br/>

  ç¢³æ°´åŒ–åˆç‰©ï¼ˆgï¼‰<br/>
<input id="carbs" oninput="autoCalculate()" type="number"/><br/>

  ç¢³æ°´æ¯”ï¼ˆCI å€¼ï¼‰<br/><span style="color:red; font-size: 14px;">é«”è‚²èª² CI è¦ +2</span><br/>
<input id="carbRatio" oninput="autoCalculate()" type="number"/><br/>

  å¯¦éš›æ‰“çš„èƒ°å³¶ç´ åŠ‘é‡<br/>
<input id="actualInsulin" oninput="autoCalculate()" type="number"/><br/>

  å‚™è¨»ï¼ˆåƒä»€éº¼ï¼‰<br/>
<input id="note" type="text"/><br/>

<button onclick="saveRecord()">å„²å­˜è³‡æ–™</button><br/><br/>
<div id="alertBox" style="color: darkred; font-weight: bold;"></div>

<div id="suggestedInsulin" style="font-weight:bold; color:green;"></div>
<div id="predictedBloodSugar" style="font-weight:bold; color:green;"></div>
</div>
<h3>ä»Šæ—¥ç´€éŒ„</h3>
<div class="record-box" id="records"></div>
<button onclick="copyRecords()">è¤‡è£½ä»Šæ—¥ç´€éŒ„</button>
<script>
let editingIndex = null;
const todayKey = "record_" + new Date().toISOString().split("T")[0];

window.onload = function() {
  loadRecords();
  autoCalculate();
};

function getCurrentTime() {
  const now = new Date();
  return now.toTimeString().slice(0,5);
}

function autoCalculate() {
  const cf = parseFloat(document.getElementById("correctionFactor").value);
  const target = parseFloat(document.getElementById("targetBloodSugar").value);
  const pre = parseFloat(document.getElementById("preMealBloodSugar").value);
  const carbs = parseFloat(document.getElementById("carbs").value);
  const ci = parseFloat(document.getElementById("carbRatio").value);
  const actual = parseFloat(document.getElementById("actualInsulin").value);

  const suggestEl = document.getElementById("suggestedInsulin");
  const predictEl = document.getElementById("predictedBloodSugar");

  if (!isNaN(pre) && !isNaN(carbs) && !isNaN(ci) && !isNaN(cf) && !isNaN(target)) {
    const suggested = ((pre - target) / cf + carbs / ci);
    suggestEl.innerText = `å»ºè­°èƒ°å³¶ç´ ï¼š${suggested.toFixed(2)} å–®ä½`;
  } else {
    suggestEl.innerText = "";
  }

  if (!isNaN(pre) && !isNaN(carbs) && !isNaN(ci) && !isNaN(actual) && !isNaN(cf)) {
    const predicted = pre - (actual - (carbs / ci)) * cf;
    predictEl.innerText = `é ä¼°è¡€ç³–ï¼š${Math.floor(predicted)} mg/dL`;
  } else {
    predictEl.innerText = "";
  }
}

function saveRecord() {
  const pre = document.getElementById("preMealBloodSugar").value;
  const carbs = document.getElementById("carbs").value;
  const ci = document.getElementById("carbRatio").value;
  const actual = document.getElementById("actualInsulin").value;
  const note = document.getElementById("note").value;
  const suggestedText = document.getElementById("suggestedInsulin").innerText.split("ï¼š")[1] || "null";
  const predictedText = document.getElementById("predictedBloodSugar").innerText.split("ï¼š")[1] || "null";
  const time = getCurrentTime();

  const entry = {
    pre, carbs, ci, actual, note,
    suggested: suggestedText, predicted: predictedText, time: time
  };

  const records = getSavedRecords();
  if (editingIndex !== null) {
    records[editingIndex] = entry;
    editingIndex = null;
  } else {
    records.push(entry);
  }

  localStorage.setItem(todayKey, JSON.stringify(records));
  resetForm();
  renderRecords(records);
}

function renderRecords(records) {
  const container = document.getElementById("records");
  container.innerHTML = "";
  records.forEach((r, i) => {
    const div = document.createElement("div");
    div.className = "record-entry";
    div.innerHTML = `#${i+1} æ™‚é–“ï¼š${r.time} é¤å‰è¡€ç³–ï¼š${r.pre}ï¼Œç¢³æ°´ï¼š${r.carbs}gï¼ŒCIï¼š${r.ci}ï¼Œæ–½æ‰“ï¼š${r.actual}Uï¼Œå‚™è¨»ï¼š${r.note}<br>å»ºè­°ï¼š${r.suggested}ï¼Œé ä¼°ï¼š${r.predicted}<br>`;
    
    const editBtn = document.createElement("button");
    editBtn.innerText = "ä¿®æ”¹";
    editBtn.onclick = () => loadToForm(i, r);

    const delBtn = document.createElement("button");
    delBtn.innerText = "åˆªé™¤";
    delBtn.onclick = () => deleteRecord(i);

    const btnBox = document.createElement("div");
    btnBox.className = "record-buttons";
    btnBox.appendChild(editBtn);
    btnBox.appendChild(delBtn);

    div.appendChild(btnBox);
    container.appendChild(div);
  });
}

function loadToForm(index, record) {
  editingIndex = index;
  document.getElementById("preMealBloodSugar").value = record.pre;
  document.getElementById("carbs").value = record.carbs;
  document.getElementById("carbRatio").value = record.ci;
  document.getElementById("actualInsulin").value = record.actual;
  document.getElementById("note").value = record.note;
  autoCalculate();
}

function deleteRecord(index) {
  const records = getSavedRecords();
  records.splice(index, 1);
  localStorage.setItem(todayKey, JSON.stringify(records));
  renderRecords(records);
}

function getSavedRecords() {
  const saved = localStorage.getItem(todayKey);
  return saved ? JSON.parse(saved) : [];
}

function resetForm() {
  document.getElementById("preMealBloodSugar").value = "";
  document.getElementById("carbs").value = "";
  document.getElementById("carbRatio").value = "";
  document.getElementById("actualInsulin").value = "";
  document.getElementById("note").value = "";
  document.getElementById("suggestedInsulin").innerText = "";
  document.getElementById("predictedBloodSugar").innerText = "";
}

function loadRecords() {
  const records = getSavedRecords();
  renderRecords(records);
}

function copyRecords() {
  const records = getSavedRecords().map((r, i) =>
    `#${i+1} æ™‚é–“ï¼š${r.time} é¤å‰è¡€ç³–ï¼š${r.pre}ï¼Œç¢³æ°´ï¼š${r.carbs}gï¼ŒCIï¼š${r.ci}ï¼Œæ–½æ‰“ï¼š${r.actual}Uï¼Œå‚™è¨»ï¼š${r.note}
å»ºè­°ï¼š${r.suggested}ï¼Œé ä¼°ï¼š${r.predicted}
`
  ).join("\n");
  navigator.clipboard.writeText(records).then(() => {
    alert("ä»Šæ—¥ç´€éŒ„å·²è¤‡è£½ï¼");
  });
}
</script>
<script>
function showRecommendations() {
    const preMeal = parseFloat(document.getElementById("preMealBloodSugar").value);
    const target = parseFloat(document.getElementById("targetBloodSugar").value);
    const cf = parseFloat(document.getElementById("correctionFactor").value);
    const carbs = parseFloat(document.getElementById("carbs").value);
    const ci = parseFloat(document.getElementById("carbRatio").value);
    const actual = parseFloat(document.getElementById("actualInsulin").value);

    let alertBox = document.getElementById("alertBox");
    alertBox.innerHTML = "";

    if (isNaN(preMeal) || isNaN(target) || isNaN(cf) || isNaN(carbs) || isNaN(ci) || isNaN(actual)) return;

    const correctionDose = (preMeal - target) / cf;
    const carbDose = carbs / ci;
    const recommended = correctionDose + carbDose;
    const estimatedBG = preMeal - ((actual - carbDose) * cf);

    let suggestions = [];

    if (estimatedBG < 80 && actual < recommended - 1) {
        suggestions.push("âš ï¸ å»ºè­°æª¢æŸ¥ä¿®æ­£å› å­ï¼Œå¯èƒ½è¨­å¤ªé«˜ã€‚");
    }

    if (preMeal > 130) {
        const now = new Date();
        if (now.getHours() >= 7 && now.getHours() <= 20) {
            suggestions.push("ğŸ“Œ é£¯å‰è¡€ç³–åé«˜ï¼Œå¯è§€å¯Ÿæ˜¯å¦éœ€å¢åŠ é•·æ•ˆèƒ°å³¶ç´ ï¼ˆ+10~20%ï¼‰ã€‚");
        }
    }

    if (preMeal < 100 && actual === 0 && carbs === 0) {
        suggestions.push("âœ… é£¯å‰è¡€ç³–ç©©å®šä¸”æœªé€²é£Ÿï¼Œå¯èƒ½å¯è€ƒæ…®èª¿é™é•·æ•ˆèƒ°å³¶ç´ ã€‚");
    }

    if (suggestions.length > 0) {
        alertBox.innerHTML = suggestions.join("<br>");
    }
}

const originalAutoCalc = autoCalculate;
autoCalculate = function() {
    originalAutoCalc();
    showRecommendations();
}
</script>
</body>